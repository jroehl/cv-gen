#!/usr/bin/env node

const { resolve, basename } = require('path');
const { existsSync } = require('fs');
require('@babel/register');

const logError = err => {
  console.error('Error generating CV');
  console.error(err.message || err);
};

const run = async () => {
  const { argv, cwd } = process;
  try {
    const [file] = argv.slice(2);
    const absolutePath = file.startsWith('/') ? file : resolve(cwd(), ...file.split('/').filter(x => x !== '.'));
    console.log(`Generating CV based on "${absolutePath}"`);
    if (!existsSync(absolutePath)) throw new Error(`File "${absolutePath}" not found`);
    const pdfName = resolve(cwd(), `${basename(absolutePath).replace('.json', '')}.pdf`);
    await require(resolve(__dirname, '..', 'server')).run(require(absolutePath), pdfName);
    console.log(`Stored CV "${pdfName}"`);
  } catch (err) {
    logError(err);
  }
};

run().catch(logError);
